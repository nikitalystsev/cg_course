\chapter{Конструкторский раздел}

В данном разделе будет приведены требования к разрабатываемому ПО, будут приведены алгоритмы построения и визуализации ландшафта, будет приведена структура разрабатываемого ПО.

\section{Требования к программному обеспечению}

Разрабатываемое программное обеспечение должно предоставлять пользователю следующую функциональность:

\begin{itemize}[label=--]
	\item изменение параметров алгоритма шума Перлина для генерации ландшафта;
	\item изменение положение источника света;
	\item возможность управления положением модели (перемещение, масштабирование, поворот);
	\item задание и изменение уровня моря в интерактивном режиме;
\end{itemize}

При этом разрабатываемая программа должна удовлетворять следующим требованиям:

\begin{itemize}[label=--]
	\item время отклика программы должно быть менее 1 секунды для корректной работы в интерактивном режиме;
	\item программа должна корректно реагировать на любые действия пользователя.
\end{itemize}

\section{Разработка алгоритмов}

\subsection{Общий алгоритм построения изображения}

На рисунке \ref{img:generalImageConstrAlg} представлена схема общего алгоритма построения изображения.

\includesvgimage
{generalImageConstrAlg} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{h} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Схема алгоритма генерации карты высот на основе шума Перлина} % Подпись рисунка

\clearpage

\subsection{Алгоритм процедурной генерации ландшафта на основе шума Перлина}

На рисунке \ref{img:genHeightMapAlg} представлена схема алгоритма генерации карты высот на основе шума Перлина.

\includesvgimage
{genHeightMapAlg} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{h} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Схема алгоритма генерации карты высот на основе шума Перлина} % Подпись рисунка

\clearpage

На рисунке \ref{img:perlinNoiseWithMultiOctavesAlg} представлена схема алгоритма шума Перлина с применением нескольких октав.

\includesvgimage
{perlinNoiseWithMultiOctavesAlg} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{h} % Положение рисунка (см. figure из пакета float)
{0.65\textwidth} % Ширина рисунка
{Схема алгоритма шума Перлина с применением нескольких октав} % Подпись рисунка

\clearpage

На рисунке \ref{img:perlinNoiseAlg} представлена схема алгоритма шума Перлина.

\includesvgimage
{perlinNoiseAlg} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{h} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Схема алгоритма шума Перлина} % Подпись рисунка

\subsection{Афинные преобразования}

Для осуществления управлением положения модели используются афинные преобразования \cite{info_affineTransform}, задающиеся матрицами.
Изменение положения точки трехмерного пространства в результате применение одного из афинных преобразований задается формулой \ref{mtr:affineTransform}.

\begin{equation}
	\label{mtr:affineTransform}
	\begin{gathered}
		(x', y', z', 1) = (x, y, z, 1) \cdot M
	\end{gathered}
\end{equation}

где $x$, $y$, $z$ -- старые координаты точки, $x'$, $y'$, $z'$ -- новые координаты точки, $M$ -- матрица афинного преобразования (формулы \ref{mtr:OX} - \ref{mtr:scale}).

Поворот вокруг одной из осей координат задается углом вращения $\alpha$ и осуществляется с помощью соответствующей матрицы поворота (формулы \ref{mtr:OX} - \ref{mtr:OZ}).

Матрица поворота вокруг оси OX:

\begin{equation}
	\label{mtr:OX}
	\begin{pmatrix}
		1 	& 0 		  & 0 	       & 0 \\
		0 	& cos \alpha  & sin \alpha & 0 \\
		0	& -sin \alpha & cos \alpha & 0 \\
		0 	& 0 		  & 0          & 1
	\end{pmatrix}
\end{equation}

Матрица поворота вокруг оси OY:

\begin{equation}
	\label{mtr:OY}
	\begin{pmatrix}
		cos \alpha 	& 0 & -sin \alpha & 0 \\
		0 			& 1 & 0 		  & 0 \\
		sin \alpha	& 0 & cos \alpha  & 0 \\
		0 			& 0 & 0           & 1
	\end{pmatrix}
\end{equation}

Матрица поворота вокруг оси OZ:

\begin{equation}
	\label{mtr:OZ}
	\begin{pmatrix}
		cos \alpha 	 & sin \alpha & 0 & 0 \\
		-sin \alpha  & cos \alpha & 0 & 0 \\
		0	 		 & 0		  & 1 & 0 \\
		0 			 & 0 		  & 0 & 1
	\end{pmatrix}
\end{equation}

Перенос в трехмерном пространстве задается значениями смещения положения точки вдоль координатных осей $OX, OY, OZ$ --- $dx, dy, dz$ соответственно.

Матрица переноса имеет вид:

\begin{equation}
	\label{mtr:move}
	\begin{pmatrix}
		1  & 0  & 0  & 0 \\
		0  & 1  & 0  & 0 \\
		0  & 0  & 1  & 0 \\
		dx & dy	& dz & 1
	\end{pmatrix}
\end{equation}

Масштабирование задается значениями коэффициентов масштабирования по каждому из направлений $OX, OY, OZ$ --- $kx, ky, kz$.

Матрица масштабирования имеет вид:

\begin{equation}
	\label{mtr:scale}
	\begin{pmatrix}
		k_x & 0   & 0   & 0 \\
		0   & k_y & 0   & 0 \\
		0   & 0   & k_z & 0 \\
		0   & 0	  & 0   & 1
	\end{pmatrix}
\end{equation}




\subsection{Модель освещения Ламберта}

Согласно общему алгоритму построения изображения (рисунок \ref{img:generalImageConstrAlg}) третьим шагом является вычисление интенсивности в каждой точке ландшафта с использованием модели освещения Ламберта.

В основе модели Ламберта лежит закон Ламберта \cite{info_lightLambert}, который утверждает, что интенсивность света, отраженного от материала, пропорциональна косинусу угла между нормалью к поверхности и направлением света. 
Это означает, что поверхности, ориентированные более к световому источнику, будут ярче, а те, которые ориентированы более в сторону от источника света, будут менее освещены.
На рисунке \ref{img:design_lambert} показан пример взаимного расположения вектора нормали (вектор $N$) и вектора направления от точки к источнику света (вектор $L$).

\includeimage
{design_lambert} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{h} % Положение рисунка (см. figure из пакета float)
{0.5\textwidth} % Ширина рисунка
{Пример расположения векторов $N$ и $L$ в модели освещения Ламберта \cite{info_lightModels}} % Подпись рисунка

Пусть:
\begin{itemize}
	\item $\vec{L}$ --- единичный вектор направления от точки до источника;
	\item $\vec{N}$ --- единичный вектор нормали;
	\item $I$ --- результирующая интенсивность света в точке;
	\item $I_0$ --- интенсивность источника света;
	\item $K_d$ --- коэффициент диффузного освещения.
\end{itemize}

Формула расчета интенсивности имеет следующий вид:

\begin{equation}
	\label{equ:lambert}
	I = I_0 \cdot K_d \cdot cos(\vec{L}, \vec{N}) \cdot I_d = I_0 \cdot K_d \cdot (\vec{L}, \vec{N})
\end{equation}


\subsection{Алгоритм, использующий Z-буфер}

На рисунке \ref{img:zbufferAlg} представлена схема алгоритма  z-буфера.

\includesvgimage
{zbufferAlg} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{h} % Положение рисунка (см. figure из пакета float)
{0.8\textwidth} % Ширина рисунка
{Схема алгоритма z-буфера} % Подпись рисунка

\clearpage

\subsection{Алгоритм закраски по Гуро}

На рисунке \ref{img:shadingByGuroAlg} представлена схема алгоритма закраски по Гуро.

\includesvgimage
{shadingByGuroAlg} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{h} % Положение рисунка (см. figure из пакета float)
{0.65\textwidth} % Ширина рисунка
{Схема алгоритма закраски по Гуро} % Подпись рисунка

\clearpage

\subsection{Алгоритм, использующий Z-буфер, объединенный с закраской по Гуро}

На рисунке \ref{img:zbufferWithShadingByGuroAlg} представлена схема алгоритма, использующего Z-буфер, объединенного с закраской по Гуро.

\includesvgimage
{zbufferWithShadingByGuroAlg} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{h} % Положение рисунка (см. figure из пакета float)
{0.6\textwidth} % Ширина рисунка
{Схема алгоритма, использующего Z-буфер, объединенного с закраской по Гуро} % Подпись рисунка

\subsection{Выбор типов и структур данных}

Для реализации разрабатываемого ПО необходимо использование структур данных, представленных в таблице \ref{tbl:tableDataPresent}.

\begin{table}[ht]
	\begin{center}
		\begin{threeparttable}
			\caption{Представление данных в ПО}
			\label{tbl:tableDataPresent}
			\begin{tabular}{|c|c|}
				\hline
				\bfseries Данные & \bfseries Представление  \\
				\hline
				Точка трехмерного пространства & Координаты по осям $x$, $y$ и $z$  \\
				\hline
				Вектор & Точка трехмерного пространства  \\
				\hline
				Карта высот & \makecell{Двумерный массив точек \\ трехмерного пространства} \\
				\hline
				\makecell{Плоскость}  &  \makecell{Три точки трехмерного пространства} \\
				\hline
				\makecell{Источник света}  &  \makecell{Точка трехмерного пространства  \\ со значениями \\ интенсивности и коэффициента} \\
				\hline
			\end{tabular}
		\end{threeparttable}
	\end{center}
\end{table}

\subsection{Описание структуры программного обеспечения}

На рисунке \ref{img:UMLClassStructure} представлена диаграмма классов разрабатываемого программного обеспечения.

\includesvgimage
{UMLClassStructure} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)Bmatrix
{f} % Обтекание (без обтекания)
{h} % Положение рисунка (см. figure из пакета float)
{0.92\textwidth} % Ширина рисунка
{Диаграмма классов} % Подпись рисунка

\clearpage

В разрабатываемом программном обеспечении реализуются следующие классы: 

\begin{itemize}[label*=---]
	\item \texttt{PerlinNoise} --- класс, хранящий параметры алгоритма шума Перлина и реализующий возможность генерации высоты для переданной точки;
	\item \texttt{Plane} --- класс для представления плоскости, являющейся треугольным полигоном;
	\item \texttt{Transform} --- класс для осуществления афинных преобразований;
	\item \texttt{Light} --- класс  для представления точечного источник света;
	\item \texttt{LightManager} --- класс для вычисления интенсивностей света в точке;
	\item \texttt{Landscape} --- класс для представления трехмерного ландшафта;
	\item \texttt{LandscapeManager} --- класс для осуществления всех операций по изменению ландшафта;
	\item \texttt{Renderer} --- класс для растеризации ландшафта и вывода его на экран.
\end{itemize}

\section*{Вывод}

На основе данных, полученных из аналитического раздела, были описаны общий алгоритм построения изображения, приведены схемы алгоритма генерации карты высот, алгоритма закраски по Гуро и алгоритма удаления невидимых линий, использующего Z-буфер. 
Было дано математическое описание модели освещения Ламберта и приведены матрицы афинных преобразований. 
Также была приведена структура разрабатываемого ПО в виде диаграммы классов и были выдвинуты требования к ПО.
